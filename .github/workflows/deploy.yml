name: build-test-deploy

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  FRONTEND_PATH: frontend
  BACKEND_PATH: backend
  HELM_CHART_PATH: deploy/helm/pm-journey

jobs:
  lint-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Enable Corepack
        run: corepack enable

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_PATH }}

      - name: Lint frontend
        run: pnpm lint
        working-directory: ${{ env.FRONTEND_PATH }}

      - name: Test frontend
        run: pnpm test -- --runInBand
        working-directory: ${{ env.FRONTEND_PATH }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ${{ env.BACKEND_PATH }}/target
          key: ${{ runner.os }}-cargo-${{ hashFiles(format('{0}/Cargo.lock', env.BACKEND_PATH)) }}

      - name: Test backend
        run: cargo test --locked
        working-directory: ${{ env.BACKEND_PATH }}

  build-deploy:
    name: Build & Deploy (${{ matrix.env.name }})
    runs-on: ubuntu-latest
    needs: lint-test
    strategy:
      fail-fast: false
      matrix:
        env:
          - name: dev
            branch: dev
            environment: dev
            helmValues: deploy/helm/pm-journey/values.dev.yaml
            acrName: pmjourneydev
            acrLoginServer: pmjourneydev.azurecr.io
            azureClientIdSecret: AZURE_CLIENT_ID_DEV
            azureTenantIdSecret: AZURE_TENANT_ID
            azureSubscriptionIdSecret: AZURE_SUBSCRIPTION_ID_DEV
            azureResourceGroupSecret: AZURE_RESOURCE_GROUP_DEV
            azureAksNameSecret: AZURE_AKS_NAME_DEV
            namespace: dev
          - name: prod
            branch: main
            environment: prod
            helmValues: deploy/helm/pm-journey/values.prod.yaml
            acrName: pmjourneyprod
            acrLoginServer: pmjourneyprod.azurecr.io
            azureClientIdSecret: AZURE_CLIENT_ID_PROD
            azureTenantIdSecret: AZURE_TENANT_ID
            azureSubscriptionIdSecret: AZURE_SUBSCRIPTION_ID_PROD
            azureResourceGroupSecret: AZURE_RESOURCE_GROUP_PROD
            azureAksNameSecret: AZURE_AKS_NAME_PROD
            namespace: prod
    if: github.ref == format('refs/heads/{0}', matrix.env.branch)
    environment: ${{ matrix.env.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build metadata
        id: meta
        run: |
          echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          echo "frontend_repo=${{ matrix.env.acrLoginServer }}/pm-journey-frontend" >> "$GITHUB_OUTPUT"
          echo "backend_repo=${{ matrix.env.acrLoginServer }}/pm-journey-backend" >> "$GITHUB_OUTPUT"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Enable Corepack
        run: corepack enable

      - name: Install frontend deps
        run: pnpm install --frozen-lockfile
        working-directory: ${{ env.FRONTEND_PATH }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets[matrix.env.azureClientIdSecret] }}
          tenant-id: ${{ secrets[matrix.env.azureTenantIdSecret] }}
          subscription-id: ${{ secrets[matrix.env.azureSubscriptionIdSecret] }}

      - name: Log in to ACR
        run: az acr login --name ${{ matrix.env.acrName }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.FRONTEND_PATH }}
          file: ${{ env.FRONTEND_PATH }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.frontend_repo }}:${{ steps.meta.outputs.tag }}

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BACKEND_PATH }}
          file: ${{ env.BACKEND_PATH }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.backend_repo }}:${{ steps.meta.outputs.tag }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets[matrix.env.azureResourceGroupSecret] }}
          cluster-name: ${{ secrets[matrix.env.azureAksNameSecret] }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install pm-journey ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ matrix.env.namespace }} \
            --create-namespace \
            --values ${{ matrix.env.helmValues }} \
            --set frontend.image.repository=${{ steps.meta.outputs.frontend_repo }} \
            --set frontend.image.tag=${{ steps.meta.outputs.tag }} \
            --set backend.image.repository=${{ steps.meta.outputs.backend_repo }} \
            --set backend.image.tag=${{ steps.meta.outputs.tag }}
